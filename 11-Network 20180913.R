###########################################################
#### Network analysis for diverse invader, Jie Hu 20180405
#### Loading packages
library(igraph)
library(psych)
library(WGCNA, lib.loc = "/Library/Frameworks/R.framework/Versions/3.4/Resources/library")

#### Reading data ####
otu<-read.table("otu.nor.txt", header=T, row.names=1, sep="\t")  ## otu rawdata
otu$abundance<-rowMeans(otu[,1:48])          ## Add abundance to otu_pro
otu$rel<-otu$abundance/sum(otu$abundance)    
otu<-otu[order(row.names(otu)),]
otu<-otu[order(otu$rel),]              ## order the data 

otu1<-subset(otu,otu$abundance>=0.1)
#otu1<-otu1[,1:52]
#otu1<-as.data.frame(t(otu1))

#write.table(otu1, file="otu20180911.txt",row.names=T, dec=".", sep="\t")

#write.table(otu_pro2, file="hub1.txt",row.names=T, dec=".", sep="\t")
#write.table(otu_pro3, file="hub2.txt",row.names=T, dec=".", sep="\t")

#occor = corr.test(otu1,use="pairwise",method="spearman",adjust="fdr",alpha=.05)
#occor.r = occor$r # ??????????????????R???
#occor.p = occor$p # ??????????????????p???

occor1=corAndPvalue(otu1,use="pairwise.complete.obs")
occor.rZ = occor1$Z   # Fisher transforms of the calculated correlations
occor.rt = occor1$t   # Student t statistics of the calculated correlations
occor.p1 = occor1$p   # 
occor.r1 = occor1$cor # the calculated correlations

## filtering 
occor.r1[occor.p1>0.05|abs(occor.r1)<0.8] = 0 
#test0<-as.data.frame(occor.r1)
#test1<-occor.r1[test0$OTU8478!=0,test0$OTU8478!=0]
#test2<-occor.r1[test0$OTU2574!=0,test0$OTU2574!=0]
#test3<-occor.r1[test0$OTU1467!=0,test0$OTU1467!=0]
#rownames(test1)<-otu_pro2$phylum
#colnames(test1)<-otu_pro2$phylum

#occor.r[occor.p>0.05|abs(occor.r)<0.6] = 0 

# put the data in igraph
igraph = graph_from_adjacency_matrix(occor.r1,mode="undirected",weighted=TRUE,diag=FALSE)
igraph

# occor.r[occor.r!=0] = 1
# igraph = graph_from_adjacency_matrix(occor.r,mode="undirected",weighted=NULL,diag=FALSE)

# ???????????????????????????????????????????????????
# remove isolated nodes?????????????????????otu??????????????????otu ????????????????????????????????????
bad.vs = V(igraph)[degree(igraph) == 0]
igraph = delete.vertices(igraph, bad.vs)
igraph

# ???igraph weight???????????????igraph.weight
igraph.weight = E(igraph)$weight

# ???????????????igraph???weight??????????????????????????????layout??????????????????
E(igraph)$weight = NA

# ????????????
# ?????????????????????????????????????????????????????????????????????????????????????????????????????????
set.seed(123)
plot(igraph,main="Co-occurrence network",vertex.frame.color=NA,vertex.label=NA,edge.width=1,
     vertex.size=5,edge.lty=1,edge.curved=TRUE,margin=c(0,0,0,0))

# ????????????????????????weighted=NULL,?????????????????????
sum(igraph.weight>0)# number of postive correlation
sum(igraph.weight<0)# number of negative correlation

# set edge color???postive correlation ?????????red, negative correlation?????????blue
E.color = igraph.weight
E.color = ifelse(E.color>0, "grey",ifelse(E.color<0, "blue","grey"))
E(igraph)$color = as.character(E.color)

# ??????edge???????????????
set.seed(123)
plot(igraph,main="Co-occurrence network",vertex.frame.color=NA,vertex.label=NA,edge.width=1,
     vertex.size=5,edge.lty=1,edge.curved=TRUE,margin=c(0,0,0,0))

# ????????????edge?????? ???set edge width???????????????????????????edge width??????
E(igraph)$width = abs(igraph.weight)*1.5

# ??????edge???????????????
set.seed(123)
plot(igraph,main="Co-occurrence network",vertex.frame.color=NA,vertex.label=NA,
     vertex.size=5,edge.lty=1,edge.curved=TRUE,margin=c(0,0,0,0))

#### Reading OTU characteristics data ####
# ??????OTU???????????????????????????????????????
otu_pro<-read.table("otu_pro.txt", header=T, row.names=1, sep="\t")  ## otu parameters
otu_pro<-otu_pro[order(row.names(otu_pro)),]                         ## order the data 
otu2<-otu[order(row.names(otu)),]
otu_pro$abundance<-otu2$abundance

otu_pro<-otu_pro[order(otu_pro$abundance),]                          ## order the data 
otu_pro<-subset(otu_pro,otu_pro$abundance>=1)
otu_pro2<-otu_pro[row.names(test1),]
otu_pro3<-otu_pro[row.names(test2),]
#otu_pro$abundance<-rowMeans(otu[,1:48])         ## Add abundance to otu_pro

# set vertices size
igraph.size = otu_pro[V(igraph)$name,]         # ????????????OTU??????
igraph.size1 = log((igraph.size$abundance)*10) # ?????????????????????????????????*100??????e??????
V(igraph)$size = igraph.size1

# set vertices color
igraph.col = otu_pro[V(igraph)$name,]
levels(igraph.col$color)
levels(igraph.col$color) = c("red","grey","orange","blue","green") # ????????????levles??????????????????????????????
V(igraph)$color = as.character(igraph.col$color)

write.table(igraph.col, file="igraph.col.txt",row.names=T, dec=".", sep="\t")
#set.seed(123)
#plot(igraph,main="Co-occurrence network",vertex.frame.color=NA,vertex.label=NA,
#     edge.lty=1,edge.curved=TRUE,margin=c(0,0,0,0))

#plot(igraph,layout=layout.fruchterman.reingold,vertex.label=NA,edge.arrow.size=1,
#     edge.lty=1,edge.curved=TRUE,margin=c(0,0,0,0))

pdf("Figure 3 network correlation hub2.pdf", height=5, width=5)
set.seed(200)
plot.igraph(igraph,layout=layout.fruchterman.reingold,vertex.label=NA,
     edge.arrow.size=1,edge.lty=1,
     edge.curved=FALSE,margin=c(0,0,0,0))
dev.off()

pdf("Figure 3 network correlation.pdf", height=10, width=10)
set.seed(200)
plot.igraph(igraph,layout=layout.fruchterman.reingold,vertex.label=NA)
dev.off()
# ??????layout,layout????????????????????????igraph?????????????????????
#pdf("Figure 3 network correlation 0.85.pdf", height=8, width=8)
#set.seed(200)
#plot(igraph,main="Co-occurrence network",layout=layout_with_kk,vertex.frame.color=NA,vertex.label=NA,
#     edge.lty=1,edge.curved=TRUE,margin=c(0,0,0,0))
#dev.off()

#pdf("Figure 3 network correlation 0.85.pdf", height=10, width=10)
#set.seed(123)
plot.igraph(igraph,main="Co-occurrence network",layout=layout.fruchterman.reingold,vertex.label.color="black",
            vertex.label.cex=0.4,edge.lty=1,edge.curved=FALSE,margin=c(0,0,0,0))

plot.igraph(igraph,vertex.size=3,vertex.label=NA,layout=layout.fruchterman.reingold)
#dev.off()

# ????????? modularity
fc = cluster_fast_greedy(igraph,weights =NULL)# cluster_walktrap cluster_edge_betweenness, cluster_fast_greedy, cluster_spinglass
modularity = modularity(igraph,membership(fc))

# ???????????????????????????
comps = membership(fc)
colbar = rainbow(max(comps))
V(igraph)$color = colbar[comps] 
